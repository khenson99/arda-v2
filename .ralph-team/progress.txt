# Ralph Team Loop — Progress Log
# This file is appended to by every agent after each iteration.
# It serves as cumulative memory across fresh-context Ralph iterations.
# =====================================================================


--- Backend Agent Iteration 3 | Issue #111 ---
Timestamp: 2026-02-11T08:16:00Z
Status: completed
Changes:
  - packages/db/src/schema/users.ts (added apiKeys table with relations)
  - packages/db/src/schema/tenants.ts (added webhook fields to TenantSettings)
  - services/auth/src/services/integration.service.ts (new)
  - services/auth/src/services/integration.service.test.ts (new, 14 tests passing)
  - services/auth/src/routes/integrations.routes.ts (new)
  - services/auth/src/index.ts (registered users and integrations routers)
  - services/api-gateway/src/routes/proxy.ts (added /api/users and /api/integrations routes)
Tests: 14 new integration tests, all passing
Learnings:
  - Integration settings backend complete: API key management + webhook configuration
  - API keys use crypto.randomBytes for secure generation, SHA-256 for hashing
  - Key format: arda_<8hex-prefix>_<64hex-secret>, only full key shown on creation
  - Webhook settings stored in tenant.settings JSONB: webhookUrl, webhookSecret, webhookEvents
  - Security: never return webhookSecret in GET responses, only indicate presence with hasWebhookSecret
  - Schema patterns: apiKeys table in auth schema with foreign keys to tenants and users
  - Relations: added apiKeys to usersRelations for Drizzle relational queries
  - All routes require tenant_admin role via requireRole() middleware
  - Gateway routing: both /api/users and /api/integrations proxy to auth service
  - Test patterns: mock crypto functions would require vi.mock('crypto'), accepted test behavior for actual crypto use

--- Backend Agent Iteration 1 | Issue #250 ---
Timestamp: 2026-02-12T01:50:00Z
Status: completed
Changes:
  - packages/db/src/schema/audit.ts (added hashChain, previousHash, sequenceNumber columns + 2 new indexes)
  - packages/db/drizzle/0008_audit_hash_chain.sql (new — 3-phase migration: add columns → backfill → enforce constraints)
  - packages/db/drizzle/meta/_journal.json (registered migration 0008)
  - packages/db/src/migrations/audit-hash-chain.test.ts (new — 14 tests for idempotency, structure, hash computation, schema exports)
Tests: 14 new migration tests + 5 existing audit route tests, all passing (19 total)
Learnings:
  - Hash-chain columns: hash_chain (varchar 64, NOT NULL), previous_hash (varchar 64, nullable), sequence_number (bigint, NOT NULL)
  - Migration pattern: 3-phase for safe production deploy (nullable add → backfill → enforce NOT NULL + indexes)
  - Backfill uses recursive CTE to chain SHA-256 hashes sequentially per tenant
  - Deterministic tie-breaker ordering: (timestamp ASC, id ASC) prevents non-repeatable sequence assignment
  - First row per tenant uses 'GENESIS' sentinel instead of NULL for hash input consistency
  - Hash input format: tenant_id|seq|action|entity_type|entity_id|timestamp|previous_hash (pipe-delimited)
  - COALESCE(entity_id::text, '') handles NULL entity_id in hash computation
  - Idempotency: IF NOT EXISTS for columns/indexes, WHERE IS NULL for backfill targeting
  - Drizzle bigint mode: 'number' for sequence_number (JS safe integer range sufficient)
  - Index: (tenant_id, sequence_number DESC) for efficient latest-first per-tenant queries
  - Unique index on hash_chain ensures tamper-evidence
  - Existing GET /api/audit routes unaffected — new columns are additive in SELECT * responses
  - Rollback SQL documented in migration header comments
