name: Resilience Gates

on:
  push:
    branches: [main, 'release/**']
    paths:
      - 'services/kanban/src/**'
      - 'services/orders/src/**'
      - 'services/auth/src/**'
      - 'packages/db/src/**'
      - '.github/workflows/resilience-gates.yml'
  pull_request:
    branches: [main]
    paths:
      - 'services/kanban/src/**'
      - 'services/orders/src/**'
      - 'services/auth/src/**'
      - 'packages/db/src/**'
      - '.github/workflows/resilience-gates.yml'

jobs:
  resilience-matrix:
    name: Resilience & Fault-Injection Matrix
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared packages
        run: npx turbo build --filter="./packages/*"

      - name: Run Resilience Test Matrix
        working-directory: services/kanban
        run: npx vitest run src/__tests__/resilience/ --reporter=verbose

      - name: Check Resilience Gates
        working-directory: services/kanban
        run: |
          REPORT_FILE="src/__tests__/resilience/resilience-report.json"

          if [ ! -f "$REPORT_FILE" ]; then
            echo "Resilience report file not found: $REPORT_FILE"
            exit 1
          fi

          VERDICT=$(jq -r '.verdict' "$REPORT_FILE")
          PASS_RATE=$(jq -r '.summary.passRate' "$REPORT_FILE")
          DATA_INTEGRITY=$(jq -r '.gates[] | select(.name=="Data Integrity") | .pass' "$REPORT_FILE")
          IDEMPOTENCY=$(jq -r '.gates[] | select(.name=="Idempotency") | .pass' "$REPORT_FILE")
          AUDIT_TRAIL=$(jq -r '.gates[] | select(.name=="Audit Trail") | .pass' "$REPORT_FILE")

          echo "## Resilience Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Verdict**: $VERDICT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          # Use awk for numeric comparison (not string comparison)
          PASS_RATE_OK=$(awk "BEGIN { print ($PASS_RATE >= 95) ? \"true\" : \"false\" }")
          echo "| Pass Rate | $([ "$PASS_RATE_OK" = "true" ] && echo '✅' || echo '❌') | ${PASS_RATE}% (target: >=95%) |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Integrity | $([ "$DATA_INTEGRITY" = "true" ] && echo '✅' || echo '❌') | $DATA_INTEGRITY |" >> $GITHUB_STEP_SUMMARY
          echo "| Idempotency | $([ "$IDEMPOTENCY" = "true" ] && echo '✅' || echo '❌') | $IDEMPOTENCY |" >> $GITHUB_STEP_SUMMARY
          echo "| Audit Trail | $([ "$AUDIT_TRAIL" = "true" ] && echo '✅' || echo '❌') | $AUDIT_TRAIL |" >> $GITHUB_STEP_SUMMARY

          if [ "$VERDICT" != "PASS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Resilience gates failed.** Review test failures before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All resilience gates passed. Safe to merge." >> $GITHUB_STEP_SUMMARY

      - name: Comment PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('services/kanban/src/__tests__/resilience/resilience-report.json', 'utf8'));
            const verdict = report.verdict;
            const passRate = report.summary.passRate;

            const icon = verdict === 'PASS' ? '✅' : '❌';
            const status = verdict === 'PASS' ? 'PASSED' : 'FAILED';

            // Use exact regex predicates to avoid category overlap (R* vs RR*)
            const byCategory = (prefix) => report.details.filter(d => new RegExp(`^${prefix}\\d+:`).test(d.scenario));

            const body = `## ${icon} Resilience Gates ${status}

            **Pass Rate**: ${passRate}% (target: >=95%)

            | Category | Passed | Total |
            |----------|--------|-------|
            | Redis Failures | ${byCategory('R').filter(d => d.passed).length} | ${byCategory('R').length} |
            | Database Failures | ${byCategory('D').filter(d => d.passed).length} | ${byCategory('D').length} |
            | Event Bus Failures | ${byCategory('E').filter(d => d.passed).length} | ${byCategory('E').length} |
            | Recovery | ${byCategory('RR').filter(d => d.passed).length} | ${byCategory('RR').length} |
            | Concurrent Ops | ${byCategory('C').filter(d => d.passed).length} | ${byCategory('C').length} |

            ### Quality Gates

            ${report.gates.map(g => `- ${g.pass ? '✅' : '❌'} **${g.name}**: ${g.value}/${g.threshold}${g.note ? ` _(${g.note})_` : ''}`).join('\n')}

            ${verdict === 'PASS' ? '✅ All resilience gates passed. Safe to merge.' : '⚠️ Resilience gates failed. Review failures before merging.'}

            <details>
            <summary>View detailed results</summary>

            \`\`\`json
            ${JSON.stringify(report, null, 2)}
            \`\`\`
            </details>`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resilience-test-results
          path: services/kanban/src/__tests__/resilience/resilience-report.json
          retention-days: 30
