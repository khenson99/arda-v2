x-service-defaults: &service-defaults
  build:
    context: .
    dockerfile: Dockerfile
  restart: unless-stopped
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
  environment: &service-env
    NODE_ENV: production
    DATABASE_URL: postgresql://arda:arda_dev_password@postgres:5432/arda_v2
    REDIS_URL: redis://redis:6379
    ELASTICSEARCH_URL: http://elasticsearch:9200
    JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production}
    JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-dev-jwt-refresh-secret-change-in-production}
    JWT_EXPIRY: ${JWT_EXPIRY:-15m}
    JWT_REFRESH_EXPIRY: ${JWT_REFRESH_EXPIRY:-7d}
    GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
    APP_URL: ${APP_URL:-http://localhost:5173}
    AWS_S3_BUCKET: ${AWS_S3_BUCKET:-arda-v2-dev}
    AWS_REGION: ${AWS_REGION:-us-east-1}

services:
  # ─── Infrastructure ──────────────────────────────────────────────────

  postgres:
    image: postgres:16-alpine
    container_name: arda-postgres
    environment:
      POSTGRES_DB: arda_v2
      POSTGRES_USER: arda
      POSTGRES_PASSWORD: arda_dev_password
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U arda -d arda_v2']
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: arda-redis
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 5s
      retries: 5

  # ─── Object Storage (S3-compatible) ─────────────────────────────────

  minio:
    image: minio/minio
    container_name: arda-minio
    profiles:
      - storage
      - full
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - '9000:9000'
      - '9001:9001'
    volumes:
      - minio_data:/data
    healthcheck:
      test: ['CMD', 'mc', 'ready', 'local']
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── Search Engine ──────────────────────────────────────────────────

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: arda-elasticsearch
    profiles:
      - search
      - full
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - '9200:9200'
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsSL http://localhost:9200/_cluster/health | grep -q ''"status":"green"\|"status":"yellow"''']
      interval: 10s
      timeout: 5s
      retries: 10

  # ─── Monitoring ─────────────────────────────────────────────────────

  prometheus:
    image: prom/prometheus:v2.50.0
    container_name: arda-prometheus
    profiles:
      - monitoring
      - full
    ports:
      - '9090:9090'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.retention.time=7d'

  grafana:
    image: grafana/grafana:10.3.0
    container_name: arda-grafana
    profiles:
      - monitoring
      - full
    ports:
      - '3100:3000'
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: 'false'
    volumes:
      - grafana_data:/var/lib/grafana

  # ─── Application Services ────────────────────────────────────────────

  api-gateway:
    <<: *service-defaults
    container_name: arda-api-gateway
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: api-gateway
    ports:
      - '4000:3000'
    environment:
      <<: *service-env
      PORT: 3000
      AUTH_SERVICE_URL: http://auth:3000
      CATALOG_SERVICE_URL: http://catalog:3000
      KANBAN_SERVICE_URL: http://kanban:3000
      ORDERS_SERVICE_URL: http://orders:3000
      NOTIFICATIONS_SERVICE_URL: http://notifications:3000

  auth:
    <<: *service-defaults
    container_name: arda-auth
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: auth
    environment:
      <<: *service-env
      PORT: 3000

  catalog:
    <<: *service-defaults
    container_name: arda-catalog
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: catalog
    environment:
      <<: *service-env
      PORT: 3000

  kanban:
    <<: *service-defaults
    container_name: arda-kanban
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: kanban
    environment:
      <<: *service-env
      PORT: 3000

  orders:
    <<: *service-defaults
    container_name: arda-orders
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: orders
    environment:
      <<: *service-env
      PORT: 3000

  notifications:
    <<: *service-defaults
    container_name: arda-notifications
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE: notifications
    environment:
      <<: *service-env
      PORT: 3000

volumes:
  postgres_data:
  redis_data:
  minio_data:
  elasticsearch_data:
  prometheus_data:
  grafana_data:
